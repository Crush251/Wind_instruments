# 重大重构更新日志

## 更新时间
2025-11-03

## 更新概述

本次更新对程序进行了两项重大改进：
1. ✅ **添加静态文件嵌入支持**（`//go:embed`）
2. ✅ **删除旧的直接演奏模式，统一为预处理流程**

---

## 一、静态文件嵌入（Embed）

### 改进目标
将 Web 静态文件和模板嵌入到可执行文件中，使程序成为单一二进制文件，便于部署。

### 实现细节

**web_server.go：**

```go
//go:embed web/static web/templates
var staticFiles embed.FS
```

**特性：**
- ✅ 静态资源（CSS/JS）嵌入
- ✅ HTML 模板嵌入
- ✅ 单一二进制文件部署
- ✅ 无需额外文件依赖（除配置和音乐文件）

**使用效果：**
```bash
# 编译后只需要：
./newsksgo          # 单一可执行文件
config.yaml         # 配置文件
trsmusic/          # 音乐源文件
exec/              # 预处理缓存文件
```

**对比：**

| 项目 | 之前 | 现在 |
|------|------|------|
| **部署文件** | 程序 + web/ 目录 | 仅程序文件 |
| **文件大小** | 小程序 + 分散文件 | 较大单文件 |
| **部署便利性** | 需要复制多个文件 | 复制单一文件 |
| **版本管理** | 多文件容易漏 | 单文件不会漏 |

---

## 二、执行流程重构

### 改进目标
删除旧的直接演奏模式，所有输入统一走预处理流程，确保性能和一致性。

### 架构变化

**之前的执行模式：**
```
模式1: 直接演奏（旧）         → 已删除 ❌
  -in xxx.json → 直接解析演奏

模式2: 预处理模式
  -preprocess -in xxx.json → 生成 exec.json

模式3: 执行预计算序列
  -json exec/xxx.exec.json → 播放
```

**现在的执行模式：**
```
模式1: 预处理模式（生成）
  -preprocess -in xxx.json → 生成 exec.json

模式2: 执行预计算序列（推荐）
  -json exec/xxx.exec.json → 播放

模式3: 自动预处理+执行（新）  ← 新增 ✨
  -in xxx.json → 自动预处理 → 自动播放

模式4: Web服务模式
  ./newsksgo → 启动Web服务
```

### 新的自动预处理+执行模式

**流程：**
```
用户输入:
  ./newsksgo -in trsmusic/青花瓷.json -instrument sn -bpm 108 -tongue 30

程序执行:
  1️⃣ 自动预处理 → exec/青花瓷_sn_108_30.exec.json
  2️⃣ 初始化硬件
  3️⃣ 自动播放

优势:
  - 一步到位
  - 自动缓存（exec文件可复用）
  - 性能优化（预计算）
  - 统一流程
```

**代码实现（main.go）：**
```go
// === 自动预处理+执行模式 ===
if *inputFile != "" {
    fmt.Println("🔄 检测到输入文件，自动进入预处理+执行模式...")
    
    // 步骤1: 预处理
    preprocessor := NewSequencePreprocessor(...)
    preprocessor.GenerateExecutionSequence(*inputFile, tempExecFile)
    
    // 步骤2: 初始化硬件
    InitGlobalPumpController(...)
    
    // 步骤3: 执行播放
    engine := NewExecutionEngine(tempExecFile, cfg)
    engine.Play()
}
```

---

## 三、删除的代码

### 主要删除内容

**main.go：**
- ❌ 删除所有 `PerformanceEngine` 相关函数（约 480 行）
- ❌ 删除 `newPerformanceEngine` 系列函数
- ❌ 删除 `playSequence` 函数
- ❌ 删除 `switchFingering` 系列函数
- ❌ 删除旧的直接演奏逻辑

**cli_executor.go：**
- ❌ 删除 `RunDirectPlayback` 函数
- ✅ 更新 `PrintUsage` 以反映新流程

**types.go：**
- 保留 `PerformanceEngine` 结构体定义（Web服务器仍需要）
- 但 main.go 不再使用该结构体

**代码行数对比：**
```
main.go:         698 行 → 217 行 （减少 481 行，-69%）
cli_executor.go: 128 行 → 73 行  （减少 55 行，-43%）
```

---

## 四、使用方式更新

### 推荐工作流

**1. 开发/测试阶段（快速迭代）：**
```bash
# 直接用音乐源文件，自动预处理+播放
./newsksgo -in trsmusic/test.json -instrument sn -bpm 120 -tongue 30
```

**2. 生产部署（最优性能）：**
```bash
# 步骤1: 批量预处理（一次性）
./newsksgo -preprocess -in trsmusic/青花瓷.json -instrument sn -bpm 108 -tongue 30
./newsksgo -preprocess -in trsmusic/茉莉花.json -instrument sn -bpm 92 -tongue 30

# 步骤2: 快速播放（重复使用）
./newsksgo -json exec/青花瓷_sn_108_30.exec.json
./newsksgo -json exec/茉莉花_sn_92_30.exec.json
```

**3. Web服务模式（远程控制）：**
```bash
# 启动服务器
./newsksgo

# 浏览器访问
http://localhost:8088

# 或者使用API
curl -X POST http://localhost:8088/api/exec/play \
  -H "Content-Type: application/json" \
  -d '{"filename": "exec/青花瓷_sn_108_30.exec.json"}'
```

---

## 五、逻辑接口映射（Hand-based）

### 重要更新

exec.json 文件现在使用逻辑标识（`left`/`right`）而非硬编码的 CAN 接口：

**新格式：**
```json
{
  "frames": [
    {
      "hand": "left",    ← 逻辑标识
      "id": "0x28",
      "d": "..."
    },
    {
      "hand": "right",   ← 逻辑标识
      "id": "0x27",
      "d": "..."
    }
  ]
}
```

**执行时映射（config.yaml）：**
```yaml
hands:
  left:
    interface: can3    # 实际硬件接口
    id: "0x28"
  right:
    interface: can2    # 实际硬件接口
    id: "0x27"
```

**优势：**
- ✅ exec 文件与硬件解耦
- ✅ 更换硬件只需改配置
- ✅ 多设备共享 exec 文件
- ✅ 配置灵活性高

**注意：** 
⚠️ 旧格式的 exec 文件**不兼容**，需要重新生成！

---

## 六、迁移指南

### 步骤 1: 更新程序
```bash
# 编译新版本
go build -o newsksgo
```

### 步骤 2: 重新生成 exec 文件
```bash
# 备份旧文件（可选）
mkdir -p backup/exec
cp exec/*.exec.json backup/exec/

# 删除旧格式文件
rm exec/*.exec.json

# 重新生成所有 exec 文件
for f in trsmusic/*.json; do
  basename=$(basename "$f" .json)
  ./newsksgo -preprocess -in "$f" -instrument sn -bpm 108 -tongue 30
done
```

### 步骤 3: 验证新文件
```bash
# 检查新格式
jq '.events[0].frames[0]' exec/test_sn_108_30.exec.json

# 应该看到：
# {
#   "hand": "left",     ← 新格式
#   "id": "0x28",
#   "d": "..."
# }

# 而不是：
# {
#   "i": "can3",        ← 旧格式（已废弃）
#   "id": "0x28",
#   "d": "..."
# }
```

### 步骤 4: 测试播放
```bash
# 测试自动预处理+执行
./newsksgo -in trsmusic/test.json -instrument sn -bpm 108

# 测试预计算序列执行
./newsksgo -json exec/test_sn_108_30.exec.json
```

---

## 七、性能优化总结

### 代码精简
- 删除 536 行旧代码
- 统一执行流程
- 减少维护负担

### 部署优化
- 单一二进制文件
- 静态资源嵌入
- 无外部依赖

### 执行优化
- 所有模式统一走预处理
- 预计算序列缓存
- 硬件配置解耦

---

## 八、兼容性说明

### 不兼容的变更
1. ❌ **旧的 exec 文件格式不兼容**
   - 原因：字段从 `i`（interface）改为 `hand`
   - 解决：重新生成所有 exec 文件

2. ❌ **旧的直接演奏模式已移除**
   - 原因：性能不佳，流程不统一
   - 替代：使用新的自动预处理+执行模式（`-in` 参数）

### 兼容的部分
1. ✅ config.yaml 配置文件格式不变
2. ✅ 音乐源文件格式不变（trsmusic/*.json）
3. ✅ Web API 接口不变
4. ✅ 命令行参数基本不变

---

## 九、常见问题

### Q1: 旧的 exec 文件能用吗？
**A:** ❌ 不能。需要重新生成。新格式使用 `hand` 字段替代 `i` 字段。

### Q2: 为什么删除直接演奏模式？
**A:** 
- 性能差（实时计算）
- 流程不统一
- 维护负担重
- 新的自动预处理+执行模式更好

### Q3: `-in` 参数还能用吗？
**A:** ✅ 能！但行为变了：
- **之前：** 直接演奏
- **现在：** 自动预处理 → 自动播放

### Q4: Web服务会受影响吗？
**A:** ✅ 不会。Web服务功能完全保留，且静态文件现在嵌入到程序中，部署更方便。

### Q5: 如何快速测试？
**A:** 
```bash
# 最快方式（使用预计算序列）
./newsksgo -json exec/test_sn_108_30.exec.json

# 一步到位方式（自动预处理）
./newsksgo -in trsmusic/test.json -instrument sn
```

---

## 十、下一步建议

### 立即执行
1. ✅ 编译新程序
2. ✅ 重新生成所有 exec 文件
3. ✅ 测试关键功能

### 优化建议
1. 📝 更新部署文档
2. 📝 更新操作手册
3. 🔄 批量生成常用曲目的 exec 文件
4. 🧪 在测试环境充分验证

### 未来规划
1. 考虑添加 exec 文件版本号
2. 考虑添加 exec 文件自动更新机制
3. 考虑添加配置热重载功能

---

## 总结

### 核心改进
1. ✅ **单一二进制部署** - embed 静态资源
2. ✅ **统一执行流程** - 全部走预处理
3. ✅ **硬件配置解耦** - hand-based 映射
4. ✅ **代码大幅精简** - 删除 500+ 行旧代码

### 影响范围
- 🔴 **破坏性变更：** 需要重新生成 exec 文件
- 🟡 **行为变更：** `-in` 参数行为改变
- 🟢 **无影响：** Web服务、配置文件、源音乐文件

### 升级路径
```
1. 编译新程序
   ↓
2. 重新生成 exec 文件
   ↓
3. 测试验证
   ↓
4. 部署到生产环境
```

---

**版本：** v2.0
**日期：** 2025-11-03
**状态：** ✅ 已完成

